{% extends "core/base.jinja" %}
{% from 'forum/macros.jinja' import display_forum %}
{% from 'core/macros.jinja' import user_profile_link %}

{% block content %}
    <div>
    <a href="{{ url('forum:main') }}">Forum</a>
    {% for f in forum.get_parent_list() %}
    > <a href="{{ f.get_absolute_url() }}">{{ f }}</a>
    {% endfor %}
    > <a href="{{ forum.get_absolute_url() }}">{{ forum }}</a>
    </div>
    <h3>{{ forum.name }}</h3>
    <p>
    {% if user.is_in_group(settings.SITH_GROUP_FORUM_ADMIN_ID) or user.is_in_group(settings.SITH_GROUP_COM_ADMIN_ID) %}
        <a href="{{ url('forum:new_forum') }}?parent={{ forum.id }}">New forum</a> <br/>
    {% endif %}
        <a href="{{ url('forum:new_topic', forum_id=forum.id) }}">New topic</a>
    </p>
    {% for f in forum.children.all() %}
    {{ display_forum(f, user) }}
    {% endfor %}
    {% for t in topics %}
    <div class="topic">
        <div class="ib w_medium">
            <a class="ib w_big" href="{{ url('forum:view_topic', topic_id=t.id) }}">
                <h5>{{ t.title }}</h5>
                <p>{{ t.description }}</p>
            </a>
            {% if user.is_owner(t) %}
            <div class="ib" style="text-align: center;">
                <a href="{{ url('forum:edit_topic', topic_id=t.id) }}">Edit</a>
            </div>
            {% endif %}
        </div>
        <div class="ib w_medium">
            <div class="ib w_medium">
                <div class="ib w_medium" style="text-align: center;">
                    {{ user_profile_link(t.author) }}
                </div>
                <div class="ib w_medium" style="text-align: center;">
                    {{ t.messages.count() }}
                </div>
            </div>
            <div class="ib w_medium" style="text-align: center;">
                {% set last_msg = t.messages.order_by('id').last() %}
                {{ user_profile_link(last_msg.author) }} <br/>
                {{ last_msg.date|date(DATETIME_FORMAT) }} {{ last_msg.date|time(DATETIME_FORMAT) }}
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock %}



