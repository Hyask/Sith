{% extends "core/base.jinja" %}
{% from 'core/macros.jinja' import user_profile_link %}

{% block title %}
{{ topic }}
{% endblock %}

{% block head %}
{{ super() }}
<style type="text/css" media="all">
.topic {
    border: solid skyblue 1px;
    padding: 2px;
    margin: 2px;
}
.forum {
    background: lightblue;
    padding: 2px;
    margin: 2px;
}
.category {
    background: skyblue;
}
</style>
{% endblock %}

{% block content %}
    <p>
    <a href="{{ url('forum:main') }}">Forum</a>
    {% for f in topic.forum.get_parent_list() %}
    > <a href="{{ f.get_absolute_url() }}">{{ f }}</a>
    {% endfor %}
    > <a href="{{ topic.forum.get_absolute_url() }}">{{ topic.forum }}</a>
    > <a href="{{ topic.get_absolute_url() }}">{{ topic }}</a>
    </p>
    <h3>{{ topic.title }}</h3>
    <p>{{ topic.description }}</p>
    <p><a href="{{ url('forum:new_message', topic_id=topic.id) }}">Reply</a></p>

    {% for m in topic.messages.select_related('author__profile_pict').all() %}
    {% if m.id >= first_unread_message_id %}
    <div id="msg_{{ m.id }}" class="message unread">
    {% else %}
    <div id="msg_{{ m.id }}" class="message">
    {% endif %}
        <div class="msg_author">
                {% if m.author.profile_pict %}
            <img src="{{ m.author.profile_pict.get_download_url() }}" alt="{% trans %}Profile{% endtrans %}" id="picture" />
            {% else %}
            <img src="{{ static('core/img/unknown.jpg') }}" alt="{% trans %}Profile{% endtrans %}" id="picture" />
            {% endif %}
            <br/>
            <strong>{{ user_profile_link(m.author) }}</strong>
        </div>
        <div {% if m.id == first_unread_message_id %}id="first_unread"{% endif %} style="display: inline-block; width: 80%; vertical-align: top;">
            <div style="display: inline-block; width: 74%;">
                {% if m.title %}
                <h5>{{ m.title }}</h5>
                {% endif %}
            </div>
            <div style="display: inline-block; width: 25%;">
                <span><a href="{{ url('forum:new_message', topic_id=topic.id) }}?quote_id={{ m.id }}">
                        {% trans %}Reply as quote{% endtrans %}</a></span>
                {% if user.can_edit(m) %}
                <span> <a href="{{ url('forum:edit_message', message_id=m.id) }}">{% trans %}Edit{% endtrans %}</a></span>
                {% endif %}
                {% if m.can_be_moderated_by(user) %}
                {% if m.deleted %}
                <span> <a href="{{ url('forum:undelete_message', message_id=m.id) }}">{% trans %}Undelete{% endtrans %}</a></span>
                {% else %}
                <span> <a href="{{ url('forum:delete_message', message_id=m.id) }}">{% trans %}Delete{% endtrans %}</a></span>
                {% endif %}
                {% endif %}
                <br/>
                <span>{{ m.date|date(DATETIME_FORMAT) }} {{ m.date|time(DATETIME_FORMAT) }}</span>
            </div>
            <hr>
            <div>
            {{ m.message|markdown }}
            </div>
            {% if m.can_be_moderated_by(user) %}
            <ul>
            {% for meta in m.metas.select_related('user').all() %}
                <li>{{ meta.get_action_display() }} {{ meta.user.get_display_name() }}
                    {% trans %} at {% endtrans %}{{ meta.date|time(DATETIME_FORMAT) }}
                    {% trans %} the {% endtrans %}{{ meta.date|date(DATETIME_FORMAT)}}</li>
            {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
    {{ m.mark_as_read(user) or "" }}
    {% endfor %}
    <p><a href="{{ url('forum:new_message', topic_id=topic.id) }}">Reply</a></p>
{% endblock %}



